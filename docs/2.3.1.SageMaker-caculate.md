# Chi Tiáº¿t: LÃ m Sáº¡ch Dá»¯ Liá»‡u (Data Cleaning) cho PhÃ¢n TÃ­ch RFM

## Tá»•ng Quan

TrÆ°á»›c khi tÃ­nh toÃ¡n cÃ¡c chá»‰ sá»‘ RFM, chÃºng ta cáº§n **lÃ m sáº¡ch dá»¯ liá»‡u** (data cleaning) Ä‘á»ƒ:
- âœ… Loáº¡i bá» cÃ¡c ghi chÃ©p khÃ´ng cáº§n thiáº¿t
- âœ… XÃ³a cá»™t khÃ´ng sá»­ dá»¥ng
- âœ… Loáº¡i bá» báº£n sao
- âœ… Chuyá»ƒn Ä‘á»•i Ä‘á»‹nh dáº¡ng dá»¯ liá»‡u
- âœ… Xá»­ lÃ½ giÃ¡ trá»‹ NULL

ÄÃ¢y lÃ  bÆ°á»›c **ráº¥t quan trá»ng** vÃ¬ dá»¯ liá»‡u chÆ°a Ä‘Æ°á»£c lÃ m sáº¡ch sáº½ dáº«n Ä‘áº¿n káº¿t quáº£ phÃ¢n tÃ­ch sai lá»‡ch.

---

## TÃ³m Táº¯t Quy TrÃ¬nh

```
Dá»® LIá»†U Gá»C
    â†“
â‘  Lá»ŒC EVENT_TYPE = 'PURCHASE'
    â†“
â‘¡ XÃ“A Cá»˜T KHÃ”NG Cáº¦N THIáº¾T
    â†“
â‘¢ LOáº I Bá» Báº¢N SÃO
    â†“
â‘£ CHUYá»‚N Äá»”I DATETIME
    â†“
â‘¤ KIá»‚M TRA NULL
    â†“
Dá»® LIá»†U Sáº CH sáºµn sÃ ng cho phÃ¢n tÃ­ch RFM
```

---

## Code Äáº§y Äá»§ 

```python
"""
Script lÃ m sáº¡ch dá»¯ liá»‡u cho phÃ¢n tÃ­ch RFM
"""

import pandas as pd
from datetime import datetime
import numpy as np

# ========== BÆ¯á»šC 1: Lá»ŒC PURCHASE ==========
print("Step 1: Lá»c chá»‰ records 'purchase'...")
df_sales = df.loc[df.event_type == 'purchase', :]
print(f"  âœ“ Rows: {len(df_sales):,}")

# ========== BÆ¯á»šC 2: XÃ“A Cá»˜T ==========
print("\nStep 2: XÃ³a cá»™t khÃ´ng cáº§n thiáº¿t...")
columns_to_drop = ['category_code', 'brand', 'product_id', 'category_id', 'user_session']
columns_to_drop = [col for col in columns_to_drop if col in df_sales.columns]
df_sales = df_sales.drop(columns=columns_to_drop)
print(f"  âœ“ Columns: {len(df_sales.columns)}")
print(f"  âœ“ Cá»™t cÃ²n láº¡i: {', '.join(df_sales.columns.tolist())}")

# ========== BÆ¯á»šC 3: LOáº I Bá» DUPLICATES ==========
print("\nStep 3: Loáº¡i bá» báº£n sao...")
dup_count = df_sales.duplicated().sum()
df_sales = df_sales.drop_duplicates()
print(f"  âœ“ Loáº¡i bá»: {dup_count:,} duplicates")
print(f"  âœ“ Rows cÃ²n láº¡i: {len(df_sales):,}")

# ========== BÆ¯á»šC 4: CHUYá»‚N DATETIME ==========
print("\nStep 4: Chuyá»ƒn Ä‘á»•i event_time thÃ nh DateTime...")
df_sales['event_time'] = pd.to_datetime(df_sales['event_time'], infer_datetime_format=True)
print(f"  âœ“ Kiá»ƒu dá»¯ liá»‡u: {df_sales['event_time'].dtype}")

# ========== BÆ¯á»šC 5: KIá»‚M TRA NULL ==========
print("\nStep 5: Kiá»ƒm tra giÃ¡ trá»‹ NULL...")
null_columns = df_sales.isnull().sum()
null_columns_count = len(null_columns[null_columns != 0])
print(f"  âœ“ Tá»•ng NULL: {df_sales.isnull().sum().sum():,}")
print(f"  âœ“ Cá»™t cÃ³ NULL: {null_columns_count}")

# ========== HIá»‚N THá»Š Káº¾T QUáº¢ ==========
print("\n" + "="*60)
print("âœ… LÃ€M Sáº CH Dá»® LIá»†U HOÃ€N Táº¤T!")
print("="*60)
print(f"\nDataFrame cÃ³ {df_sales.shape[0]:,} rows, {df_sales.shape[1]} columns, {null_columns_count} null values")
print("\nğŸ“‹ 5 dÃ²ng Ä‘áº§u cá»§a dá»¯ liá»‡u Ä‘Ã£ lÃ m sáº¡ch:")
display(df_sales.head())
```

## Pháº§n 1: Lá»c Chá»‰ Ghi ChÃ©p "Purchase" (Mua HÃ ng)

### Code:
```python
# Chá»‰ chá»n cÃ¡c ghi chÃ©p cÃ³ event_type = 'purchase'
df_sales = df.loc[df.event_type == 'purchase', :]
```

### Giáº£i ThÃ­ch Chi Tiáº¿t:

#### **Äiá»u GÃ¬ Xáº£y Ra?**

```
DataFrame Gá»‘c (df):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ event_type | user_id | event_time  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ view       | 123     | 2024-01-01  â”‚  âŒ Loáº¡i bá» (chá»‰ xem)
â”‚ cart       | 123     | 2024-01-02  â”‚  âŒ Loáº¡i bá» (thÃªm vÃ o giá»)
â”‚ purchase   | 123     | 2024-01-03  â”‚  âœ… Giá»¯ láº¡i (mua hÃ ng)
â”‚ view       | 456     | 2024-01-04  â”‚  âŒ Loáº¡i bá»
â”‚ purchase   | 456     | 2024-01-05  â”‚  âœ… Giá»¯ láº¡i
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

            â†“

DataFrame Sau Lá»c (df_sales):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ event_type | user_id | event_time  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ purchase   | 123     | 2024-01-03  â”‚
â”‚ purchase   | 456     | 2024-01-05  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Pháº§n 2: XÃ³a Cá»™t KhÃ´ng Cáº§n Thiáº¿t

### Code:
```python
# XÃ³a cÃ¡c cá»™t khÃ´ng sá»­ dá»¥ng
df_sales = df_sales.drop(
    columns=['category_code', 'brand', 'product_id', 'category_id', 'user_session']
)
```

### Giáº£i ThÃ­ch Chi Tiáº¿t:

#### **Táº¡i Sao Pháº£i XÃ³a Cá»™t?**

| Cá»™t | LÃ½ Do XÃ³a |
|-----|----------|
| **category_code** | KhÃ´ng cáº§n cho tÃ­nh RFM (chá»‰ cáº§n user_id, event_time, price) |
| **brand** | KhÃ´ng cáº§n cho tÃ­nh RFM |
| **product_id** | KhÃ´ng cáº§n cho tÃ­nh RFM |
| **category_id** | KhÃ´ng cáº§n cho tÃ­nh RFM |
| **user_session** | KhÃ´ng cáº§n cho tÃ­nh RFM |

```
TrÆ°á»›c xÃ³a:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ user_id | event_type | event_time | price | category_code | brand  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 123     | purchase   | 2024-01-03 | 100   | electronics   | Sony   â”‚
â”‚ 456     | purchase   | 2024-01-05 | 250   | fashion       | Nike   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
Sau xÃ³a:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ user_id | event_type | event_time | price   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 123     | purchase   | 2024-01-03 | 100     â”‚
â”‚ 456     | purchase   | 2024-01-05 | 250     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Pháº§n 3: Loáº¡i Bá» Báº£n Sao (Duplicates)

### Code:
```python
# Loáº¡i bá» cÃ¡c hÃ ng trÃ¹ng láº·p
df_sales = df_sales.drop_duplicates()
```

### Giáº£i ThÃ­ch Chi Tiáº¿t:

```
DataFrame cÃ³ báº£n sao:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ user_id | event_time | price              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 123     | 2024-01-03 | 100   âœ… HÃ ng 1    â”‚
â”‚ 123     | 2024-01-03 | 100   âŒ Báº¢N SAO   â”‚  â† HÃ ng nÃ y giá»‘ng hÃ ng 1
â”‚ 456     | 2024-01-05 | 250   âœ… HÃ ng 2    â”‚
â”‚ 456     | 2024-01-05 | 250   âŒ Báº¢N SAO   â”‚  â† HÃ ng nÃ y giá»‘ng hÃ ng 2
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“ Sau drop_duplicates()
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ user_id | event_time | price              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 123     | 2024-01-03 | 100   âœ… Giá»¯ láº¡i  â”‚
â”‚ 456     | 2024-01-05 | 250   âœ… Giá»¯ láº¡i  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Pháº§n 4: Chuyá»ƒn Äá»•i Äá»‹nh Dáº¡ng Thá»i Gian (DateTime)

### Code:
```python
# Chuyá»ƒn Ä‘á»•i cá»™t "event_time" thÃ nh Ä‘á»‹nh dáº¡ng DateTime
df_sales['event_time'] = pd.to_datetime(df_sales['event_time'], infer_datetime_format=True)
```

### Giáº£i ThÃ­ch Chi Tiáº¿t:

#### **Táº¡i Sao Pháº£i Chuyá»ƒn Äá»•i?**

| LÃ½ Do | Giáº£i ThÃ­ch |
|------|-----------|
| **TÃ­nh toÃ¡n Recency** | Cáº§n trá»« ngÃ y (datetime - datetime) |
| **Sáº¯p xáº¿p theo thá»i gian** | KhÃ´ng thá»ƒ sáº¯p xáº¿p string nhÆ° datetime |
| **Lá»c theo ngÃ y** | Dá»… dÃ ng lá»c dá»¯ liá»‡u tá»« ngÃ y X Ä‘áº¿n Y |
| **Äá»‹nh dáº¡ng chuáº©n** | Loáº¡i bá» cÃ¡c Ä‘á»‹nh dáº¡ng khÃ´ng chuáº©n |

#### **So SÃ¡nh TrÆ°á»›c vÃ  Sau:**

```python
# TrÆ°á»›c chuyá»ƒn Ä‘á»•i
print(df_sales['event_time'].dtype)  # â† object (string)
print(df_sales['event_time'].head())
# Output: 
# 0    2024-01-03 10:30:45
# 1    2024-01-05 14:20:15
# 2    2024-01-07 08:15:00

# âŒ KhÃ´ng thá»ƒ tÃ­nh toÃ¡n: datetime - datetime khÃ´ng hoáº¡t Ä‘á»™ng
try:
    days_ago = datetime.now() - df_sales['event_time'].iloc[0]
    print(days_ago)
except Exception as e:
    print(f"Lá»—i: {e}")


# Sau chuyá»ƒn Ä‘á»•i
df_sales['event_time'] = pd.to_datetime(df_sales['event_time'], infer_datetime_format=True)

print(df_sales['event_time'].dtype)  # â† datetime64[ns]
print(df_sales['event_time'].head())
# Output:
# 0   2024-01-03 10:30:45
# 1   2024-01-05 14:20:15
# 2   2024-01-07 08:15:00

# âœ… CÃ³ thá»ƒ tÃ­nh toÃ¡n
days_ago = datetime.now() - df_sales['event_time'].iloc[0]
print(f"Days ago: {days_ago.days}")  # â† Hoáº¡t Ä‘á»™ng!
```

---

## Pháº§n 5: Kiá»ƒm Tra GiÃ¡ Trá»‹ NULL

### Code:
```python
# Kiá»ƒm tra giÃ¡ trá»‹ NULL
nullcolumns = df_sales.isnull().sum()
nullnumbers = len(nullcolumns[nullcolumns != 0])

print("Sau khi lÃ m sáº¡ch dá»¯ liá»‡u, DataFrame cÃ³ {} rows, {} columns, vÃ  {} null values.\n".format(
    df_sales.shape[0], df_sales.shape[1], nullnumbers))
```

### Giáº£i ThÃ­ch Chi Tiáº¿t:

#### **PhÃ¢n TÃ­ch Chi Tiáº¿t Code:**

```python
# Step 1: TÃ¬m sá»‘ NULL trong má»—i cá»™t
nullcolumns = df_sales.isnull().sum()
# Result: Series chá»©a sá»‘ NULL cho má»—i cá»™t
# user_id        0
# event_time     0
# price          2
# dtype: int64

print(nullcolumns)

# Step 2: Lá»c chá»‰ cá»™t cÃ³ NULL
nullcolumns[nullcolumns != 0]
# Result:
# price    2
# dtype: int64

# Step 3: Äáº¿m sá»‘ cá»™t cÃ³ NULL
nullnumbers = len(nullcolumns[nullcolumns != 0])
# Result: 1 (chá»‰ cá»™t 'price' cÃ³ NULL)

print(f"Sá»‘ cá»™t cÃ³ NULL: {nullnumbers}")
```
---

## Pháº§n 6: Hiá»ƒn Thá»‹ Káº¿t Quáº£ Cuá»‘i CÃ¹ng

### Code:
```python
print("After data selection and cleansing, the dataframe has {} rows, {} columns, and {} null value.\n".format(
    df_sales.shape[0], df_sales.shape[1], nullnumbers))
print("Shown below are the first 3 rows of the cleaned dataframe:\n")
display(df_sales.head(3))
```

---

**BÆ°á»›c tiáº¿p theo:** HÃ£y chuyá»ƒn sang pháº§n tÃ­nh toÃ¡n chá»‰ sá»‘ RFM! ğŸš€