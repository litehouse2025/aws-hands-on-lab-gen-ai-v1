# 2.3.3. T√≠nh to√°n Ch·ªâ s·ªë RFM

## Gi·ªõi thi·ªáu v·ªÅ RFM Analysis

RFM (Recency, Frequency, Monetary) l√† m·ªôt ph∆∞∆°ng ph√°p ph√¢n t√≠ch kh√°ch h√†ng d·ª±a tr√™n ba ch·ªâ s·ªë ch√≠nh:

| Ch·ªâ s·ªë | ƒê·ªãnh nghƒ©a | √ù nghƒ©a |
|--------|-----------|--------|
| **Recency (R)** | Kho·∫£ng th·ªùi gian k·ªÉ t·ª´ l·∫ßn mua cu·ªëi c√πng | Kh√°ch h√†ng ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y hay kh√¥ng |
| **Frequency (F)** | S·ªë l·∫ßn kh√°ch h√†ng mua h√†ng | Kh√°ch h√†ng quay l·∫°i bao nhi√™u l·∫ßn |
| **Monetary (M)** | T·ªïng gi√° tr·ªã ti·ªÅn mua h√†ng c·ªßa kh√°ch h√†ng | Kh√°ch h√†ng chi ti√™u bao nhi√™u |

## Quy tr√¨nh T√≠nh to√°n RFM

### **B∆∞·ªõc 1: T√≠nh to√°n Recency (T√≠nh g·∫ßn ƒë√¢y)**

X√°c ƒë·ªãnh th·ªùi gian k·ªÉ t·ª´ l·∫ßn mua cu·ªëi c√πng c·ªßa kh√°ch h√†ng, l·∫•y th√°ng 2 nƒÉm 2020 l√†m m·ªëc tham chi·∫øu:

```python
# √Ånh x·∫° th√°ng sang ƒëi·ªÉm s·ªë (0 = g·∫ßn nh·∫•t, 4 = l√¢u nh·∫•t)
d = {"Oct": 4, "Nov": 3, "Dec": 2, "Jan": 1, "Feb": 0}
df_sales.loc[:, 'Recency'] = df_sales['month'].map(d)

# Nh√≥m theo user_id v√† l·∫•y gi√° tr·ªã Recency nh·ªè nh·∫•t (g·∫ßn nh·∫•t)
df_R = df_sales.groupby('user_id')['Recency'].min().reset_index().rename(columns={"0": "Recency"})
```

### **B∆∞·ªõc 2: T√≠nh to√°n Frequency (T·∫ßn su·∫•t)**

ƒê·∫øm s·ªë l·∫ßn kh√°ch h√†ng th·ª±c hi·ªán giao d·ªãch:

```python
# Nh√≥m theo user_id v√† ƒë·∫øm s·ªë l·∫ßn mua h√†ng
df_F = df_sales.groupby('user_id')['event_type'].count().reset_index().rename(columns={"event_type": "Frequency"})
```

### **B∆∞·ªõc 3: T√≠nh to√°n Monetary (Gi√° tr·ªã Ti·ªÅn)**

T√≠nh t·ªïng gi√° tr·ªã giao d·ªãch c·ªßa m·ªói kh√°ch h√†ng:

```python
# Nh√≥m theo user_id v√† t√≠nh t·ªïng gi√° tr·ªã mua h√†ng
df_M = df_sales.groupby('user_id')['price'].sum().reset_index().rename(columns={"price": "Monetary"})
```

### **B∆∞·ªõc 4: G·ªôp c√°c Ch·ªâ s·ªë RFM**

K·∫øt h·ª£p ba b·∫£ng Recency, Frequency, v√† Monetary th√†nh m·ªôt b·∫£ng d·ªØ li·ªáu duy nh·∫•t:

```python
# G·ªôp Recency v√† Frequency
df_RF = pd.merge(df_R, df_F, on='user_id')

# G·ªôp v·ªõi Monetary
df_RFM = pd.merge(df_RF, df_M, on='user_id')
```

### **B∆∞·ªõc 5: Lo·∫°i b·ªè Outliers (Ngo·∫°i l·ªá)**

Tr∆∞·ªõc khi √°p d·ª•ng K-Means clustering, lo·∫°i b·ªè c√°c gi√° tr·ªã ngo·∫°i l·ªá b·∫±ng ph∆∞∆°ng ph√°p Z-score:

```python
# T√≠nh Z-score: (gi√° tr·ªã - trung b√¨nh) / ƒë·ªô l·ªách chu·∫©n
# Gi·ªØ l·∫°i c√°c gi√° tr·ªã c√≥ Z-score < 3
conditions = np.abs(stats.zscore(df_RFM.loc[:, ['Recency', 'Frequency', 'Monetary']])) < 3).all(axis=1)

# T·∫°o b·∫£ng d·ªØ li·ªáu ƒë√£ lo·∫°i b·ªè outliers
df_RFM2 = df_RFM.loc[conditions, :]

# Hi·ªÉn th·ªã 5 d√≤ng ƒë·∫ßu ti√™n
df_RFM2.head(5)
```

## K·∫øt qu·∫£

B·∫£ng d·ªØ li·ªáu RFM sau khi t√≠nh to√°n v√† lo·∫°i b·ªè outliers:

![B·∫£ng k·∫øt qu·∫£ RFM](images/rfm.png)

Trong b·∫£ng k·∫øt qu·∫£, b·∫°n c√≥ th·ªÉ th·∫•y:
- **user_id**: M√£ ƒë·ªãnh danh kh√°ch h√†ng
- **Recency**: Th·ªùi gian k·ªÉ t·ª´ l·∫ßn mua cu·ªëi c√πng (0 = g·∫ßn nh·∫•t)
- **Frequency**: S·ªë l·∫ßn kh√°ch h√†ng mua h√†ng
- **Monetary**: T·ªïng gi√° tr·ªã mua h√†ng

---

> üí° **M·∫πo:** D·ªØ li·ªáu RFM n√†y s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng cho b∆∞·ªõc ti·∫øp theo - **K-Means Clustering** ƒë·ªÉ ph√¢n nh√≥m kh√°ch h√†ng th√†nh c√°c segment kh√°c nhau.

üëâ **[Ti·∫øp theo: Bi·ªÉu ƒë·ªì Elbow ‚Üí](2.7.SageMaker-elbow.md)**